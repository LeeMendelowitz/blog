<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Lee On Coding, My blog about coding and stuff.">

        <link rel="alternate"  href="https://leemendelowitz.github.io/blog/feeds/all.atom.xml" type="application/atom+xml" title="Lee On Coding Full Atom Feed"/>

        <title>Ubuntu Server Virtual Machine with SSH using VirtualBox on Mac OS X // Lee On Coding // My blog about coding and stuff.</title>


    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.3.0/pure-min.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.1.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://leemendelowitz.github.io/blog/theme/css/pure.css">
    <link rel="stylesheet" href="https://leemendelowitz.github.io/blog/theme/css/pygments.css">

    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/fitvids/1.0.1/jquery.fitvids.min.js"></script>
    <script>
        $(document).ready(function(){
            $(".content").fitVids();
        });
    </script>
</head>

<body>
    <div class="pure-g-r" id="layout">
        <div class="sidebar pure-u">
            <div class="cover-img" style="background-image: url('images/ss3.psd.png')">
                <div class="cover-body">
                    <header class="header">
                        <hgroup>
                            <img class="avatar" src="images/twitter_img.png">
                            <h1 class="brand-main"><a href="/">Lee On Coding</a></h1>
                            <p class="tagline">My blog about coding and stuff.</p>
                                <p class="social">
                                    <a href="http://twitter.com/lmendy7">
                                        <i class="fa fa-twitter fa-3x"></i>
                                    </a>
                                    <a href="https://github.com/LeeMendelowitz">
                                        <i class="fa fa-github fa-3x"></i>
                                    </a>
                                <p>
                        </hgroup>
                    </header>
                </div>
            </div>
        </div>
    <div class="pure-u">
        <div class="content">
            <section class="post">
                <header class="post-header">
                    <h1>Ubuntu Server Virtual Machine with SSH using VirtualBox on Mac OS X</h1>
                        <p class="post-meta">
                            // under                                 <a class="post-category" href="https://leemendelowitz.github.io/blog/tag/ubuntu.html">Ubuntu</a>
                                <a class="post-category" href="https://leemendelowitz.github.io/blog/tag/virtualbox.html">VirtualBox</a>
                        </p>
                </header>
            </section>
            <p>My laptop is a late 2011 MacBook Pro running OS X 10.9 Mavericks. It's my personal laptop, so I use it for everything - browsing, e-mail, and programming. While the OS X experience is wonderful, application development can be frustrating. For example, right now I'm trying to develop a Boost Python module, and I am having trouble compiling it on OS X.</p>
<p>I intend to run my application in a Linux environment, so instead of learning the intricacies of porting my code and makefile to Mac OS X, I decided to install a local Ubuntu Server virtual machine (VM) on my MacBook. I installed Ubuntu Server instead of Ubuntu Desktop because I wanted to run a lightweight Linux environment, which should save laptop resources. I simply run the VM in the background, and ssh into it from the Mac terminal. Easy and awesome!</p>
<p><strong> This entire tutorial should take approximately 20 minutes (not including download times). </strong></p>
<h2>Install VirtualBox</h2>
<p>Download and install VirtualBox <a href="https://www.virtualbox.org/wiki/Downloads">here</a>. The
instructions below were testing with VirtualBox 4.3.18 on OS X 10.9.5.</p>
<h2>Download Ubuntu</h2>
<p>Download the <a href="http://www.ubuntu.com/download/server">Ubuntu Server 14.04.01 LTS</a> iso image. </p>
<h2>Setting up the Virtual Machine (VM)</h2>
<p>You can configure your virtual machine (VM) using the VirtualBox graphical program, but it's quicker to set it up from the command line. I've adapted these commands in part from this <a href="http://www.perkin.org.uk/posts/create-virtualbox-vm-from-the-command-line.html">blog post</a>.</p>
<p>The commands below will create a virtual machine called "UbuntuServer",
attach a 32 GB virtual hard drive, attach a DVD
drive loaded with the Ubuntu Server disk image, and allocate 1 GB of RAM. We also 
attach a network card and set up port forwarding. </p>
<!-- All of these settings can be easily changed in the future (except expanding the virtual hard ddrive size is kind of tricky because you'll have to [resize the drive partition](http://www.howtogeek.com/124622/how-to-enlarge-a-virtual-machines-disk-in-virtualbox-or-vmware/)). If you are curious, you can read more about these vboxmanage commands by referring to the [VirtualBox documentation](https://www.virtualbox.org/manual/ch08.html). -->

<div class="highlight"><pre><span class="nb">cd</span> ~/VirtualBox<span class="se">\ </span>VMs/

<span class="c"># Change these variables as needed</span>
<span class="nv">VM_NAME</span><span class="o">=</span><span class="s2">&quot;UbuntuServer&quot;</span>
<span class="nv">UBUNTU_ISO_PATH</span><span class="o">=</span>~/Downloads/ubuntu-14.04.1-server-amd64.iso
<span class="nv">VM_HD_PATH</span><span class="o">=</span><span class="s2">&quot;UbuntuServer.vdi&quot;</span> <span class="c"># The path to VM hard disk (to be created).</span>
<span class="nv">SHARED_PATH</span><span class="o">=</span>~ <span class="c"># Share home directory with the VM</span>


vboxmanage createvm --name <span class="nv">$VM_NAME</span> --ostype Ubuntu_64 --register
vboxmanage createhd --filename <span class="nv">$VM_NAME</span>.vdi --size 32768
vboxmanage storagectl <span class="nv">$VM_NAME</span> --name <span class="s2">&quot;SATA Controller&quot;</span> --add sata --controller IntelAHCI
vboxmanage storageattach <span class="nv">$VM_NAME</span> --storagectl <span class="s2">&quot;SATA Controller&quot;</span> --port 0 --device 0 --type hdd --medium <span class="nv">$VM_HD_PATH</span>
vboxmanage storagectl <span class="nv">$VM_NAME</span> --name <span class="s2">&quot;IDE Controller&quot;</span> --add ide
vboxmanage storageattach <span class="nv">$VM_NAME</span> --storagectl <span class="s2">&quot;IDE Controller&quot;</span> --port 0 --device 0 --type dvddrive --medium <span class="nv">$UBUNTU_ISO_PATH</span>
vboxmanage modifyvm <span class="nv">$VM_NAME</span> --ioapic on
vboxmanage modifyvm <span class="nv">$VM_NAME</span> --memory 1024 --vram 128
vboxmanage modifyvm <span class="nv">$VM_NAME</span> --nic1 nat
vboxmanage modifyvm <span class="nv">$VM_NAME</span> --natpf1 <span class="s2">&quot;guestssh,tcp,,2222,,22&quot;</span>
vboxmanage modifyvm <span class="nv">$VM_NAME</span> --natdnshostresolver1 on
vboxmanage sharedfolder add <span class="nv">$VM_NAME</span> --name shared --hostpath <span class="nv">$SHARED_PATH</span> --automount
</pre></div>


<h3>Start the VM for the first time</h3>
<p>For the first boot, we will start the VM with a graphical display so we can install
the Ubuntu operating system. <strong>From your OS X terminal</strong>:</p>
<div class="highlight"><pre>vboxmanage startvm UbuntuServer
</pre></div>


<p>The VM will boot from the DVD Drive, which has the Ubuntu Server installation CD image loaded. </p>
<h3>Install Ubuntu Server</h3>
<p>Install Ubuntu Server using the installation wizard with the default settings. The installer is interactive - it should take about 10 minutes to complete the installation. As part of the installation you will be asked to select a username and a password. </p>
<p>After installation is complete, the machine will reboot. Log in at the prompt.</p>
<p><strong>Hint</strong>: If you accidentally click on the VM GUI window, VirtualBox may "hijack" your mouse pointer to try passing it to the VM. If this happens and you lose your mouse pointer, press the left command key to get your mouse pointer back.</p>
<h3>Install the OpenSSH Server</h3>
<p>After installing the Ubuntu operating system and logging in to VM, to install the ssh server, issue the following command <strong>in the Ubuntu VM</strong>:</p>
<div class="highlight"><pre>sudo apt-get update
sudo apt-get install -y openssh-server
</pre></div>


<p>Now you can try logging into your virtual machine over ssh through port 2222, which has been set up to forward to port 22 of your VM. <strong>From the OS X terminal</strong>:</p>
<div class="highlight"><pre>ssh -p 2222 &lt;username&gt;@localhost
</pre></div>


<p>Congrats! :-)</p>
<p>For the rest of this installation guide, I recommend issuing all VM commands over ssh because the display is better than the VM GUI console, and you can easily paste commands into the Mac ssh terminal.</p>
<h3>Install VirtualBox Guest Additions (for shared folders)</h3>
<p>To share a folder from your host machine (i.e. Mac) with the VM, you need to install
the VirtualBox Guest Additions in the VM. </p>
<p>Before you can install the Guest additions, you need to install <code>gcc</code> and <code>make</code> into the VM. Make sure your laptop is connected to the internet (<strong>in the VM</strong>):</p>
<div class="highlight"><pre>sudo apt-get -y install gcc make linux-headers-<span class="k">$(</span>uname -r<span class="k">)</span>
</pre></div>


<p>From the VirtualBox VM GUI window menu, select "Devices -&gt; Insert Guest Additions CD Image...". If prompted, choose "Force Unmount". </p>
<p>This will insert the VirtualBox GuestAdditions installation CD into the VM's DVD drive. From the VM terminal (or, more comfortably, the ssh terminal), mount the CD drive and run the installation script. <strong>In the VM</strong>:</p>
<div class="highlight"><pre>sudo mount /dev/sr0 /media/cdrom
sudo /media/cdrom/VBoxLinuxAdditions.run
</pre></div>


<p>Finally, add your user to the <code>vboxsf</code> group so you can access shared folders (<strong>in the VM</strong>)</p>
<div class="highlight"><pre>sudo usermod -g vboxsf &lt;username&gt;
</pre></div>


<p>For the GuestAdditions installation to take effect, you need to reboot the VM. We'll take care of that in the next section when we boot the VM without a GUI.</p>
<h3>Starting the VM without GUI.</h3>
<p>Now that ssh has been installed and configured, you can run the VM in the background without a GUI window.</p>
<p>First, shutdown the VM using one of these methods:</p>
<ul>
<li>From the VM GUI, close the window and select "Send Shutdown Signal", OR</li>
<li>From the VM GUI menu, select "Machine -&gt; ACPI Shutdown" OR</li>
<li>From the Mac terminal, issue <code>vboxmanage controlvm UbuntuServer poweroff</code></li>
</ul>
<p>Next, start the VM without a GUI from the OS X terminal:</p>
<div class="highlight"><pre>vboxmanage startvm UbuntuServer --type headless
</pre></div>


<p>The VM will be running in the background. Give the VM a few moments to boot up, and then you can try to log in again over ssh as before from the OX X terminal: <code>ssh -p 2222 &lt;username&gt;@localhost</code>.</p>
<h3>Access shared folders</h3>
<p>To access your Mac home directory from the VM:</p>
<div class="highlight"><pre><span class="n">cd</span> <span class="o">/</span><span class="n">media</span><span class="o">/</span><span class="n">sf_shared</span>
<span class="n">ls</span> <span class="o">-</span><span class="n">l</span>
</pre></div>


<p>Your files should be there. If you get a "permission denied", make sure you added your user to the <code>vboxsf</code> group.</p>
<p>Contratulations. Now you have a local lightweight Linux environment that you can access over ssh!</p>
<h2>Quick Reference</h2>
<p>To shutdown the VM:</p>
<div class="highlight"><pre>vboxmanage controlvm UbuntuServer poweroff
</pre></div>


<p>You can also pause the VM instead of shutting it down:</p>
<div class="highlight"><pre>vboxmanage controlvm UbuntuServer savestate
</pre></div>


<p>To start the VM:</p>
<div class="highlight"><pre>vboxmanage startvm UbuntuServer --type headless
</pre></div>


<p>To log into the VM over ssh:</p>
<div class="highlight"><pre>ssh -p 2222 &lt;username&gt;@localhost
</pre></div>


<h2>Additional Tweaks</h2>
<p>Here are some solutions to other issues that may arise:</p>
<h3>Configure the Grub Boot Loader</h3>
<p>On one occasion I powered off the VM while it was booting. The next time time I tried to start the VM without the GUI, I could not log in over ssh because, unknown to me at the time, the VM was sitting in the GRUB bootloader menu waiting for my input. </p>
<p>You can configure GRUB to timeout by editing the VM's GRUB configuration file at
<code>/etc/default/grub</code> with the line:</p>
<div class="highlight"><pre><span class="n">GRUB_RECORDFAIL_TIMEOUT</span><span class="o">=</span><span class="mi">2</span>
</pre></div>


<p>which will
timeout the bootloader with the default selection after 2 seconds whenever the system
is started after the last boot failed. For more info, see the <a href="https://help.ubuntu.com/community/Grub2">Ubuntu GRUB 2 page.</a>.</p>
<h3>Keeping SSH Alive when laptop sleeps</h3>
<p>Configure the VM ssh server to keep connections alive by editing the VM's config file
<code>/etc/ssh/sshd_config</code> and adding the following:</p>
<div class="highlight"><pre>ClientAliveInterval 300
ClientAliveCountMax 2
</pre></div>


<p>When your laptop sleeps, you may find that your ssh connection to the VM is terimnated.
This is the result of some <a href="https://www.virtualbox.org/ticket/12441">VirtualBox bug</a> which has since been resolved provided that you change the VM's DNS resolution setting:</p>
<div class="highlight"><pre>VBoxManage modifyvm UbuntuServer --natdnshostresolver1 on
</pre></div>


<p>That did the trick for me.</p>
            <a href="#" class="go-top">Go Top</a>
    <div class="comments">
        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = "leeoncoding"; // required: replace example with your forum shortname

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>
<footer class="footer">
    <p>&copy; Lee Mendelowitz &ndash;
        Built with <a href="https://github.com/PurePelicanTheme/pure-single">Pure Theme</a>
        for <a href="http://blog.getpelican.com/">Pelican</a>
    </p>
</footer>        </div>
    </div>
    </div>
    <script>
        var $top = $('.go-top');

        // Show or hide the sticky footer button
        $(window).scroll(function() {
            if ($(this).scrollTop() > 200) {
                $top.fadeIn(200);
            } else {
                $top.fadeOut(200);
            }
        });

        // Animate the scroll to top
        $top.click(function(event) {
            event.preventDefault();
            $('html, body').animate({scrollTop: 0}, 300);
        })

        // Makes sure that the href="#" attached to the <a> elements
        // don't scroll you back up the page.
        $('body').on('click', 'a[href="#"]', function(event) {
            event.preventDefault();
        });
    </script>
    <script type="text/javascript">
        var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
        document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
        try {
            var pageTracker = _gat._getTracker("UA-44545448-1");
            pageTracker._trackPageview();
            } catch(err) {}
    </script>

</body>
</html>